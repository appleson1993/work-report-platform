# WorkLog Manager Security Configuration

# 防止訪問敏感檔案
<Files ~ "^\.">
    Order allow,deny
    Deny from all
</Files>

# 保護配置檔案
<FilesMatch "\.(ini|conf|cfg|log)$">
    Order allow,deny
    Deny from all
</FilesMatch>

# 防止直接訪問PHP配置檔案
<FilesMatch "^(config|security)\.php$">
    Order allow,deny
    Deny from all
</FilesMatch>

# 防止執行上傳的檔案
<Directory "uploads">
    Options -ExecCGI
    AddHandler cgi-script .php .pl .py .jsp .asp .sh .cgi
    Order allow,deny
    Allow from all
</Directory>

# 安全標頭
<IfModule mod_headers.c>
    # 防止XSS攻擊
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options DENY
    Header always set X-XSS-Protection "1; mode=block"
    
    # 內容安全政策
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' cdnjs.cloudflare.com cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' cdnjs.cloudflare.com fonts.googleapis.com; font-src 'self' fonts.gstatic.com cdnjs.cloudflare.com; img-src 'self' data:; connect-src 'self';"
    
    # 嚴格傳輸安全 (HTTPS)
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
    
    # 推薦人政策
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
</IfModule>

# 隱藏伺服器資訊
ServerTokens Prod
ServerSignature Off

# 防止SQL注入模式
<IfModule mod_rewrite.c>
    RewriteEngine On
    
    # 阻擋常見攻擊模式
    RewriteCond %{QUERY_STRING} (<|%3C).*script.*(>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} GLOBALS(=|\[|\%[0-9A-Z]{0,2}) [OR]
    RewriteCond %{QUERY_STRING} _REQUEST(=|\[|\%[0-9A-Z]{0,2}) [OR]
    RewriteCond %{QUERY_STRING} ^.*(\(|\)|<|>|%3c|%3e).* [NC,OR]
    RewriteCond %{QUERY_STRING} ^.*(\\x00|\\x04|\\x08|\\x0d|\\x1b|\\x20|\\x3c|\\x3e|\\x7f).* [NC,OR]
    RewriteCond %{QUERY_STRING} (NULL|OUTFILE|LOAD_FILE) [OR]
    RewriteCond %{QUERY_STRING} (\.{1,}/)+(motd|etc|bin) [NC,OR]
    RewriteCond %{QUERY_STRING} (localhost|loopback|127\.0\.0\.1) [NC,OR]
    RewriteCond %{QUERY_STRING} (<|>|'|%0A|%0D|%27|%3C|%3E|%00) [NC]
    RewriteRule ^(.*)$ - [F,L]
    
    # 防止直接訪問PHP檔案（除了入口點）
    RewriteCond %{REQUEST_FILENAME} -f
    RewriteCond %{REQUEST_URI} !/index\.php$ [NC]
    RewriteCond %{REQUEST_URI} !/dashboard\.php$ [NC]
    RewriteCond %{REQUEST_URI} !/admin\.php$ [NC]
    RewriteCond %{REQUEST_URI} !/attendance_admin\.php$ [NC]
    RewriteCond %{REQUEST_URI} !/logout\.php$ [NC]
    RewriteCond %{REQUEST_URI} \.php$ [NC]
    RewriteRule ^(.*)$ - [F,L]
</IfModule>

# 檔案大小限制
LimitRequestBody 10485760  # 10MB

# 超時設定
Timeout 300

# 防止目錄瀏覽
Options -Indexes

# 錯誤頁面
ErrorDocument 403 /index.php
ErrorDocument 404 /index.php
